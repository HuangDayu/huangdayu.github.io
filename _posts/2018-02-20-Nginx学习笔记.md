---
title: Nginx学习笔记
type: Nginx
date: 2018-02-20 10:24:14
category: 
- 研讨技术
tags:
- Nginx
permalink: /blog/14
---

## 前言

&emsp;&emsp;Nginx是一个高性能的正向代理和反向代理的服务器。

<!-- more -->

## 安装最新版本[^1]

安装先决条件：

```shell
sudo yum install yum-utils
```

要设置yum存储库，请创建名为/etc/yum.repos.d/nginx.repo的文件，其内容如下：

 ```shell
 [nginx-stable]
 name=nginx stable repo
 baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
 gpgcheck=1
 enabled=1
 gpgkey=https://nginx.org/keys/nginx_signing.key
 module_hotfixes=true
 
 [nginx-mainline]
 name=nginx mainline repo
 baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
 gpgcheck=1
 enabled=0
 gpgkey=https://nginx.org/keys/nginx_signing.key
 module_hotfixes=true
 ```

默认情况下，使用稳定的nginx软件包的存储库。如果要使用主线nginx软件包，请运行以下命令：

 ```shell
 sudo yum-config-manager --enable nginx-mainline
 ```

要安装nginx，请运行以下命令：

 ```shell
 sudo yum install nginx
 ```

查看安装结果：

```shell
nginx -V
```


## 反向代理

### 配置文件路径

```shell
sudo vim /etc/nginx/nginx.conf
sudo vim /usr/local/nginx/conf/nginx.conf
```


### 反向代理Tomcat

```ini
user www www;
worker_processes auto;

error_log /data/wwwlogs/error_nginx.log crit;
pid /var/run/nginx.pid;
worker_rlimit_nofile 51200;

events {
  use epoll;
  worker_connections 51200;
  multi_accept on;
}

#tcp代理
#http://nginx.org/en/docs/stream/ngx_stream_core_module.html
stream {
  
    #limit_conn_zone $binary_remote_addr zone=addr:10m;
    #limit_conn addr 200;

    #http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html
    upstream stream_backend {
        server 192.168.2.168:1883;
        least_conn;			#根据最小连接数进行负载均衡
        #server 192.168.2.168:1883 weight=5;
        #server 192.168.2.168:12345 max_fails=2 fail_timeout=30s;
        #server 192.168.2.168:12345 max_conns=3;
    }

    server {
        listen        1883 so_keepalive=on;
        proxy_pass    stream_backend;
        proxy_buffer_size 1024k;        #消息容量
        proxy_timeout 1d;               #心跳超时
        proxy_connect_timeout 1m;       #连接超时
        tcp_nodelay on;
    }
  
}

#http 代理
http {
  include mime.types;
  default_type application/octet-stream;
  server_names_hash_bucket_size 128;
  client_header_buffer_size 32k;
  large_client_header_buffers 4 32k;
  client_max_body_size 1024m;
  client_body_buffer_size 10m;
  sendfile on;
  tcp_nopush on;
  keepalive_timeout 120;
  server_tokens off;
  tcp_nodelay on;

  fastcgi_connect_timeout 300;
  fastcgi_send_timeout 300;
  fastcgi_read_timeout 300;
  fastcgi_buffer_size 64k;
  fastcgi_buffers 4 64k;
  fastcgi_busy_buffers_size 128k;
  fastcgi_temp_file_write_size 128k;
  fastcgi_intercept_errors on;

  #Gzip Compression
  gzip on;
  gzip_buffers 16 8k;
  gzip_comp_level 6;
  gzip_http_version 1.1;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;
  gzip_types
    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml
    text/javascript application/javascript application/x-javascript
    text/x-json application/json application/x-web-app-manifest+json
    text/css text/plain text/x-component
    font/opentype application/x-font-ttf application/vnd.ms-fontobject
    image/x-icon;
  gzip_disable "MSIE [1-6]\.(?!.*SV1)";

  ##Brotli Compression
  #brotli on;
  #brotli_comp_level 6;
  #brotli_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;

  ##If you have a lot of static files to serve through Nginx then caching of the files' metadata (not the actual files' contents) can save some latency.
  #open_file_cache max=1000 inactive=20s;
  #open_file_cache_valid 30s;
  #open_file_cache_min_uses 2;
  #open_file_cache_errors on;

  log_format me '$remote_addr - [$time_iso8601] request:"$request" request_length:$request_length status_code:$status handler_time:$request_time response_length:$body_bytes_sent';
  #log_format debug '$remote_addr - [$time_iso8601] request:"$uri" args:"$args" dm:"$request_body" handler_time:$request_time response_length:$bytes_sent';
  log_format debug escape=json '{ "@timestamp": "$time_iso8601", '
                       '"remote_addr": "$remote_addr",'
                       '"uri": "$uri",'
                       '"request_time": "$request_time",'
                       '"upstream_response_time": "$upstream_response_time",'
                       '"status": $status,'
                       '"request": "$request",'
                       '"bytes":$body_bytes_sent,'
                       '"dm":$request_body }';


  upstream cloud-gateway {
    server localhost:8022;
  }

  upstream service-auth {
    server localhost:8023;
  }


#######################default############################
  server {
    listen 80;
    listen 443 ssl;
    
    server_name _;

    #ssl证书地址
    ssl_certificate     /usr/local/nginx/cert/xxxxxx.pem;  #pem文件的路径
    ssl_certificate_key  /usr/local/nginx/cert/xxxxxx.key; #key文件的路径

    #ssl验证相关配置
    ssl_session_timeout  5m;    #缓存有效期
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;    #加密算法
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;    #安全链接可选的加密协议
    ssl_prefer_server_ciphers on;   #使用服务器端的首选算法


    #ssl on;

    #access_log /data/wwwlogs/access_nginx.log me;
    access_log /data/wwwlogs/access_nginx.log debug;
    #root /data/wwwroot/default;
    root /404.html;
    index index.html index.htm index.jsp;
    #error_page 404 /404.html;
    #error_page 502 /502.html;

    location / {
        root   html;
        index  index.html index.htm;
    }
    
    location /v1/ {
      chunked_transfer_encoding off;
      autoindex on; #当设置为on的时候表示打开目录浏览功能
      autoindex_exact_size on; #显示文件大小
      autoindex_localtime on; #显示文件时间
      proxy_pass http://cloud-gateway/v1/;
      proxy_set_header X-Forwarded-Proto $scheme;              
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;
      proxy_redirect off;
    }

    location /oauth/ {
      chunked_transfer_encoding off;
      autoindex on; #当设置为on的时候表示打开目录浏览功能
      autoindex_exact_size on; #显示文件大小
      autoindex_localtime on; #显示文件时间
      proxy_pass http://service-auth/oauth/;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;
      proxy_redirect off;
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Methods 'GET,POST,OPTIONS,PUT,DELETE';
      add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
    }

    location /nacos/ {
      proxy_pass http://localhost:8848/nacos/;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /files {
      alias /home/upload/files;
      autoindex on; #当设置为on的时候表示打开目录浏览功能
      autoindex_exact_size on; #显示文件大小
      autoindex_localtime on; #显示文件时间
    }

    location /web/ {
      alias /home/web/;
      autoindex_exact_size on; #显示文件大小
      autoindex_localtime on; #显示文件时间
    }

    #location /nginx_status {
    #stub_status on;
    #access_log off;
    #allow 127.0.0.1;
    #deny all;
    #}
    #location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {
    #expires 30d;
    #access_log off;
    #}
    #location ~ .*\.(js|css)?$ {
    #expires 7d;
    #access_log off;
    #}
    #location ~ {
    #proxy_pass http://127.0.0.1:8080;
    #include proxy.conf;
    #}
    #location ~ ^/(\.user.ini|\.ht|\.git|\.svn|\.project|LICENSE|README.md) {
    #deny all;
    #}
  }
##########################vhost#############################
  include vhost/*.conf;
}
```

### 反向代理thinkphp

```ini
#http://wiki.nginx.org/Pitfalls
#http://wiki.nginx.org/QuickStart
#http://wiki.nginx.org/Configuration

server {
	listen 80 default_server;
	listen [::]:80 default_server;

	root /var/www/html;

	index index.php index.html index.htm index.nginx-debian.html;

	server_name _;
	location / {
        if (!-e $request_filename) {
	        rewrite ^/index.php(.*)$ /index.php?s=$1 last;
	        rewrite ^(.*)$ /index.php?s=$1 last;
        	break;
	    }
	}
	sendfile off;
	client_max_body_size 100m;

	location ~ \.php$ {
		root    /var/www/html/;                           #php文件所在的根目录
		index index.html index.htm index.php;
        fastcgi_pass 127.0.0.1:9000;                      #fpm监听的IP和端口
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

	}
	location ~ .*\.(gif|jpg|jpeg|png)$ {  
	    expires 24h;  
	}

}
```


## 参考文献

- [nginx linux package](http://nginx.org/en/linux_packages.html#RHEL-CentOS)
- [Nginx 官方文档](http://nginx.org/en/docs/)


## 脚注

[^1]: 2021-03-03 更新   